# For Statefulset
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: {{ template "eric-data-object-storage-mn.fullname" . }}-pdb
  labels: {{- include "eric-data-object-storage-mn.helm-labels" . | nindent 4 }}
  annotations: {{- include "eric-data-object-storage-mn.helm-annotations" . | nindent 4 }}
spec:
  # return .Values.podDisruptionBudget.minAvailable if replicaCount is greater than 1
  # else (i.e replicaCount <=1) return 0
  {{- if gt (int .Values.replicaCount) 1 }}
  minAvailable: {{ .Values.podDisruptionBudget.minAvailable }}
  {{- else}}
  minAvailable: 0
  {{- end }}
  selector:
    matchLabels:
      app: {{ template "eric-data-object-storage-mn.fullname" . }}
      release: {{ .Release.Name }}
---
# For Deployment
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: {{ template "eric-data-object-storage-mn.fullname" . }}-proxy-pdb
  labels: {{- include "eric-data-object-storage-mn.helm-labels" . | nindent 4 }}
  annotations: {{- include "eric-data-object-storage-mn.helm-annotations" . | nindent 4 }}
spec:
  # if replicaCount is 1 and podDisruptionBudget is not 0 or 0%
  {{- $pdbMinAvailableInt := int (replace "%" "" (toString .Values.podDisruptionBudget.minAvailable)) }}
  {{- if and (gt (int .Values.replicaCount) 1) (ne $pdbMinAvailableInt 0) }}
  minAvailable: 1
  {{- else}}
  minAvailable: 0
  {{- end }}
  selector:
    matchLabels:
      app: {{ template "eric-data-object-storage-mn.fullname" . }}-proxy
      release: {{ .Release.Name }}
